<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Certificate Verification - Dalswin Institute</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #2980b9;
      --accent1: #b1c5a4;
      --accent2: #b5bdbc;
      --light: #f9f9f9;
      --danger: #c0392b;
      --success: #27ae60;
      --warning: #f39c12; /* Added for resend button */
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--accent1) 0%, var(--light) 25%, var(--accent2) 50%, var(--light) 75%);
      background-size: 200% 200%;
      min-height: 100vh;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: gradientAnimation 12s ease infinite;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      max-width: 700px;
      width: 100%;
      margin: 20px auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
      transform: translateY(0);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      animation: fadeIn 0.8s ease-out;
    }
    .container:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
      animation: slideDown 0.6s ease-out;
    }
    .logo {
      height: 80px;
      margin-bottom: 10px;
      filter: drop-shadow(0 3px 5px rgba(0,0,0,0.1));
    }
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 25px;
      font-size: 28px;
      position: relative;
      padding-bottom: 10px;
      animation: fadeIn 0.8s ease-out 0.1s both;
    }
    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(to right, var(--accent1), var(--accent2));
      border-radius: 2px;
    }
    .input-group {
      margin-bottom: 20px;
      position: relative;
      animation: fadeIn 0.8s ease-out 0.2s both;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: var(--primary);
      font-weight: 600;
    }
    input {
      width: 100%;
      padding: 14px 15px;
      font-size: 16px;
      border: 2px solid #e1e1e1;
      border-radius: 8px;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }
    input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.2);
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn {
      flex: 1;
      min-width: 150px;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(to right, var(--secondary), #3498db);
      color: white;
      box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3);
    }
    .btn-primary:hover {
      background: linear-gradient(to right, #2878a9, #2d8bc8);
      box-shadow: 0 6px 15px rgba(41, 128, 185, 0.4);
      transform: translateY(-2px);
    }
    .btn-secondary {
      background-color: var(--light);
      color: var(--primary);
      border: 2px solid #e1e1e1;
    }
    .btn-secondary:hover {
      background-color: #f0f0f0;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: linear-gradient(to right, var(--danger), #e74c3c);
      color: white;
    }
    .btn-success {
      background: linear-gradient(to right, var(--success), #2ecc71);
      color: white;
    }
    /* New style for resend button */
    .btn-warning {
      background: linear-gradient(to right, var(--warning), #e67e22);
      color: white;
    }
    .btn-warning:hover {
      background: linear-gradient(to right, #d35400, #e67e22);
      transform: translateY(-2px);
    }
    .result-container {
      margin-top: 25px;
      animation: fadeIn 0.8s ease-out;
    }
    .result, .private-result {
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.5s ease-out;
    }
    .result {
      background-color: #f0f7ff;
      border-left: 4px solid var(--secondary);
    }
    .private-result {
      background-color: #f0f9f0;
      border-left: 4px solid var(--success);
      display: none;
    }
    .result h3, .private-result h3 {
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    .info-item {
      margin-bottom: 10px;
      display: flex;
    }
    .info-label {
      font-weight: 600;
      min-width: 150px;
      color: var(--primary);
    }
    .info-value {
      flex: 1;
      color: #555;
    }
    hr {
      margin: 25px 0;
      border: none;
      border-top: 1px solid #e1e1e1;
    }
    .auth-section {
      animation: fadeIn 0.8s ease-out 0.3s both;
    }
    .courses-list {
      list-style-type: none;
      padding: 0;
    }
    .courses-list li {
      padding: 10px 15px;
      margin-bottom: 8px;
      background-color: white;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      transition: transform 0.2s ease;
    }
    .courses-list li:hover {
      transform: translateX(5px);
    }
    .course-code {
      font-weight: 600;
      color: var(--secondary);
    }
    .course-grade {
      font-weight: 600;
      color: var(--success);
    }
    .spinner {
      display: none;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .footer {
      text-align: center;
      margin-top: 25px;
      color: #777;
      font-size: 14px;
      animation: fadeIn 0.8s ease-out 0.4s both;
    }
    .pdf-notification {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: var(--success);
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @media (max-width: 600px) {
      body {
        padding: 20px 10px;
      }
      .container {
        padding: 20px;
      }
      .btn {
        min-width: 100%;
      }
      .btn-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="pdf-notification" id="pdfNotification">
    <i class="fas fa-check-circle"></i> PDF generated successfully!
  </div>
  <div class="container">
    <div class="logo-container">
      <img src="https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/05/chatgpt-image-jun-7-2025-03_30_54-pm.png" alt="Dalswin Institute Logo" class="logo">
      <h2>Certificate Verification</h2>
    </div>
    <div class="input-group">
      <label for="serial"><i class="fas fa-certificate"></i> Certificate Serial Number</label>
      <input type="text" id="serial" placeholder="Enter Certificate Serial Number">
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="verify()" id="verifyBtn">
        <i class="fas fa-search"></i> Verify (Public Info)
        <div class="spinner" id="verifySpinner"></div>
      </button>
    </div>
    <div class="result-container">
      <div id="basicInfo" class="result">
        <h3>Certificate Information</h3>
        <p>Enter a certificate serial number to verify its authenticity.</p>
      </div>
      <div id="privateInfo" class="private-result">
        <h3>Course Grades</h3>
        <p>Login to access detailed course information.</p>
      </div>
    </div>
    <hr>
    <div class="auth-section" id="authSection">
      <!-- Verification Message Area (Hidden by default) -->
      <div id="verificationMessage" style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404;">
        <p><i class="fas fa-exclamation-triangle"></i> <strong>Email Verification Required:</strong> Please check your email (<span id="verificationEmail"></span>) and click the verification link. Refresh this page after verifying.</p>
         <div class="btn-group">
             <button class="btn btn-warning" onclick="resendVerificationEmail()" id="resendBtn">
                 <i class="fas fa-paper-plane"></i> Resend Verification Email
                 <div class="spinner" id="resendSpinner"></div>
             </button>
         </div>
      </div>
      <div class="input-group">
        <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
        <input type="email" id="email" placeholder="Enter your email">
      </div>
      <div class="input-group">
        <label for="password"><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="password" placeholder="Enter your password">
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="login()" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> Login for Full Info
          <div class="spinner" id="loginSpinner"></div>
        </button>
        <button class="btn btn-secondary" onclick="resetPassword()">
          <i class="fas fa-key"></i> Forgot Password?
        </button>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-danger" id="logoutBtn" onclick="logout()" style="display: none;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
      <button class="btn btn-primary" onclick="downloadPDF()" id="downloadBtn">
        <i class="fas fa-download"></i> Download as PDF
        <div class="spinner" id="pdfSpinner"></div>
      </button>
    </div>
    <div class="footer">
      <p>© 2025 Dalswin Institute. All rights reserved.</p>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDM1LGJdUBN8zDLCzTjjxQtkzkeUHtuCSU",
      authDomain: "dashboard-c0263.firebaseapp.com",
      projectId: "dashboard-c0263",
      storageBucket: "dashboard-c0263.firebasestorage.app",
      messagingSenderId: "177312727757",
      appId: "1:177312727757:web:5d2d926a71eb12d503df84"
    };

    firebase.initializeApp(firebaseConfig);

    let currentSerial = "";

    function showSpinner(id) {
      const spinner = document.getElementById(id);
      if (spinner) spinner.style.display = 'inline-block';
    }

    function hideSpinner(id) {
      const spinner = document.getElementById(id);
      if (spinner) spinner.style.display = 'none';
    }

    // Function to send email verification
    function sendEmailVerificationAfterSignup(user) {
        user.sendEmailVerification()
            .then(() => {
                console.log("Verification email sent.");
                // Optionally, alert the user immediately
                // alert("A verification email has been sent to " + user.email + ". Please verify your email.");
            })
            .catch((error) => {
                console.error("Error sending verification email:", error);
                alert("Failed to send verification email. Please try again later.");
            });
    }

    // Function to resend verification email
    function resendVerificationEmail() {
        const user = firebase.auth().currentUser;
        if (user) {
            showSpinner('resendSpinner');
            document.getElementById('resendBtn').disabled = true;
            user.sendEmailVerification()
                .then(() => {
                    alert("Verification email resent to " + user.email + ".");
                })
                .catch((error) => {
                    console.error("Error resending verification email:", error);
                    alert("Failed to resend verification email. Please try again later.");
                })
                .finally(() => {
                    hideSpinner('resendSpinner');
                    document.getElementById('resendBtn').disabled = false;
                });
        } else {
             alert("No user is currently signed in.");
        }
    }


    function verify() {
      currentSerial = document.getElementById("serial").value.trim();
      if (!currentSerial) {
        alert("Please enter a certificate serial number");
        return;
      }
      showSpinner('verifySpinner');
      document.getElementById('verifyBtn').disabled = true;
      fetch(`https://script.google.com/macros/s/AKfycbyff4Jma4aT5p1lyURdqn1baUQf2AIgMbNw00pB71Sb_TdaehQsuk0Hz7-FYAMna6r5fw/exec?serial=${currentSerial}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            document.getElementById("basicInfo").innerHTML = `
              <h3>Certificate Information</h3>
              <p class="error">${data.error}</p>
            `;
          } else {
            let html = `
              <h3>Certificate Information</h3>
              <div class="info-item">
                <span class="info-label">Full Name:</span>
                <span class="info-value">${data["Full Name"]}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Program:</span>
                <span class="info-value">${data["Program"]}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Graduation Year:</span>
                <span class="info-value">${data["Grad Year"]}</span>
              </div>
            `;
            document.getElementById("basicInfo").innerHTML = html;
          }
        })
        .catch(err => {
          alert("Error verifying certificate: " + err.message);
          document.getElementById("basicInfo").innerHTML = `
            <h3>Certificate Information</h3>
            <p class="error">An error occurred while verifying the certificate.</p>
          `;
        })
        .finally(() => {
          hideSpinner('verifySpinner');
          document.getElementById('verifyBtn').disabled = false;
        });
    }

    function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) {
        alert("Please enter both email and password");
        return;
      }
      showSpinner('loginSpinner');
      document.getElementById('loginBtn').disabled = true;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCred => {
            const user = userCred.user;
            if (user.emailVerified) {
                // Email is verified, proceed with loading private info
                document.getElementById("logoutBtn").style.display = "inline-block";
                document.getElementById("authSection").style.display = "none";
                document.getElementById("verificationMessage").style.display = "none"; // Hide message if shown
                loadPrivateInfo(user.email);
            } else {
                // Email is NOT verified
                console.log("User email not verified.");
                // Sign out the user
                return firebase.auth().signOut().then(() => {
                     // Show verification message
                    document.getElementById("verificationEmail").textContent = user.email;
                    document.getElementById("verificationMessage").style.display = "block";
                    alert("Email not verified. Please check your email (" + user.email + ") for the verification link and click it. You can then log in again.");
                });
            }
        })
        .catch(err => {
          console.error("Login failed:", err);
          alert("Login failed: " + err.message);
        })
        .finally(() => {
          hideSpinner('loginSpinner');
          document.getElementById('loginBtn').disabled = false;
        });
    }

    function resetPassword() {
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Enter your email first");
      showSpinner('loginSpinner'); // Reuse login spinner for reset
      document.getElementById('loginBtn').disabled = true; // Disable login button during reset
      firebase.auth().sendPasswordResetEmail(email)
        .then(() => alert("Password reset link sent to your email!"))
        .catch(err => {
            console.error("Error sending reset email:", err);
            alert("Error sending reset email: " + err.message);
        })
        .finally(() => {
          hideSpinner('loginSpinner');
          document.getElementById('loginBtn').disabled = false;
        });
    }

    function logout() {
      showSpinner('verifySpinner');
      firebase.auth().signOut()
        .then(() => {
          // Hide logout button and show auth section on logout
          document.getElementById("logoutBtn").style.display = "none";
          document.getElementById("authSection").style.display = "block";
          document.getElementById("privateInfo").style.display = "none"; // Hide private info
          document.getElementById("verificationMessage").style.display = "none"; // Hide verification message
          // Clear private info content
          document.getElementById("privateInfo").innerHTML = `
            <h3>Course Grades</h3>
            <p>Login to access detailed course information.</p>
          `;
          console.log("User signed out.");
        })
        .catch((error) => {
            console.error("Logout error:", error);
            alert("Logout failed. Please try again.");
        })
        .finally(() => {
            hideSpinner('verifySpinner');
        });
    }

    function loadPrivateInfo(email) {
      if (!currentSerial) return alert("Enter certificate serial first.");
      document.getElementById('privateInfo').innerHTML = `
        <h3>Loading Course Information</h3>
        <div style="text-align:center; padding:20px;">
          <div class="spinner" style="width:40px;height:40px;margin:0 auto;"></div>
        </div>
      `;
      document.getElementById("privateInfo").style.display = "block";
      fetch(`https://script.google.com/macros/s/AKfycbyff4Jma4aT5p1lyURdqn1baUQf2AIgMbNw00pB71Sb_TdaehQsuk0Hz7-FYAMna6r5fw/exec?serial=${currentSerial}&email=${email}`)
        .then(res => res.json())
        .then(data => {
          if (!data.Courses || data.Courses.length === 0) {
            document.getElementById("privateInfo").innerHTML = `
              <h3>Course Grades</h3>
              <p>No grades found or email doesn't match.</p>
            `;
            return;
          }
          let courseHTML = "<h3>Course Grades</h3><ul class='courses-list'>";
          data.Courses.forEach(c => {
            courseHTML += `
              <li>
                <span class="course-code">${c["Course Code"]}</span>
                <span>${c["Course Name"]}</span>
                <span class="course-grade">${c["Grade"]}</span>
              </li>
            `;
          });
          courseHTML += "</ul>";
          document.getElementById("privateInfo").innerHTML = courseHTML;
        })
        .catch(err => {
          document.getElementById("privateInfo").innerHTML = `
            <h3>Course Grades</h3>
            <p>Error loading course information: ${err.message}</p>
          `;
        });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const basicInfoDiv = document.getElementById("basicInfo");
      const privateInfoDiv = document.getElementById("privateInfo");
      showSpinner('pdfSpinner');
      document.getElementById('downloadBtn').disabled = true;
      // Delay to allow spinner to show
      setTimeout(() => {
        let content = "";
        let title = "Certificate Verification Details";
        if (privateInfoDiv && privateInfoDiv.style.display === "block") {
          content = privateInfoDiv.innerText;
        } else {
          content = basicInfoDiv.innerText;
        }
        if (!content.trim()) {
          alert("No content available to download.");
          hideSpinner('pdfSpinner');
          document.getElementById('downloadBtn').disabled = false;
          return;
        }
        // Add title and styling
        pdf.setFontSize(20);
        pdf.text(title, 105, 20, null, null, 'center');
        // Add logo
        const logoUrl = "https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/05/chatgpt-image-jun-7-2025-03_30_54-pm.png";
        const img = new Image();
        img.src = logoUrl;
        img.crossOrigin = "Anonymous";
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const imgData = canvas.toDataURL('image/png');
          // Add logo to PDF
          pdf.addImage(imgData, 'PNG', 15, 30, 30, 30);
          // Add content
          pdf.setFontSize(12);
          const lines = pdf.splitTextToSize(content, 180);
          pdf.text(lines, 15, 70);
          // Add footer
          pdf.setFontSize(10);
          const date = new Date().toLocaleDateString();
          pdf.text(`Generated on ${date} - Dalswin Institute`, 105, 280, null, null, 'center');
          // Save and notify
          pdf.save("dalswin_certificate_details.pdf");
          hideSpinner('pdfSpinner');
          document.getElementById('downloadBtn').disabled = false;
          // Show success notification
          const notification = document.getElementById('pdfNotification');
          notification.style.display = 'block';
          setTimeout(() => {
            notification.style.display = 'none';
          }, 3000);
        };
        img.onerror = function() {
          // If logo fails to load, proceed without it
          pdf.setFontSize(12);
          const lines = pdf.splitTextToSize(content, 180);
          pdf.text(lines, 15, 30);
          // Add footer
          pdf.setFontSize(10);
          const date = new Date().toLocaleDateString();
          pdf.text(`Generated on ${date} - Dalswin Institute`, 105, 280, null, null, 'center');
          pdf.save("dalswin_certificate_details.pdf");
          hideSpinner('pdfSpinner');
          document.getElementById('downloadBtn').disabled = false;
          // Show success notification
          const notification = document.getElementById('pdfNotification');
          notification.style.display = 'block';
          setTimeout(() => {
            notification.style.display = 'none';
          }, 3000);
        };
      }, 500);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user is already logged in
      firebase.auth().onAuthStateChanged(user => {
        if (user) {
            if (user.emailVerified) {
                // If already logged in and verified, show logout and hide auth
                document.getElementById("logoutBtn").style.display = "inline-block";
                document.getElementById("authSection").style.display = "none";
                // You might want to automatically load private info here if serial is known
                // loadPrivateInfo(user.email); // Only if currentSerial is set
            } else {
                // User is logged in but email not verified
                console.log("Logged in user's email is not verified.");
                // Sign out automatically or show message? Let's sign out for security.
                firebase.auth().signOut().then(() => {
                     console.log("Signed out non-verified user on page load.");
                     // Show verification message if needed, or just rely on login attempt
                }).catch((error) => {
                    console.error("Error signing out non-verified user:", error);
                });
            }
        }
        // If no user, auth section remains visible by default
      });
    });
  </script>
</body>
</html>